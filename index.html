<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>ìš°ì„±ê³  ì¹´ë“œ ì„¤ì¹˜</title>

  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#e0e5ec" />

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="ìš°ì„±ê³  ì¹´ë“œ" />
  <link rel="apple-touch-icon" href="./icon-192.png" />

  <style>
    html, body { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; overflow: hidden; }

    body {
      display: flex; justify-content: center; align-items: center;
      background: linear-gradient(-45deg, #e0e5ec, #d1d9e6, #c8d0e7, #b8c6dc);
      background-size: 400% 400%; animation: bg 15s ease infinite;
      color: #3d4a5c;
    }
    @keyframes bg { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

    .wrap { width: min(560px, 92vw); position: relative; z-index: 10; }
    .card {
      background: #e0e5ec; border-radius: 26px; padding: 30px 26px;
      box-shadow: 9px 9px 16px rgba(163,177,198,0.7), -9px -9px 16px rgba(255,255,255,0.9);
      text-align: center;
    }

    h1 { margin: 0 0 10px; font-size: 1.6rem; color: #3d4a5c; }
    .desc { color: #5a677b; margin-bottom: 20px; line-height: 1.5; font-size: 1.05rem; word-break: keep-all; }

    .badge { display: inline-block; padding: 6px 12px; border-radius: 999px; background: rgba(0,0,0,0.06); font-size: 0.9rem; color: #5a677b; margin-bottom: 10px; }
    .warn { margin-top: 10px; font-weight: 800; color: #d63031; font-size: 0.95rem; }

    ol { margin: 15px 0 0 0; padding-left: 20px; text-align: left; line-height: 1.8; color: #5a677b; display: inline-block; }
    li { margin: 8px 0; }

    .btns { display: flex; flex-direction: column; align-items: center; gap: 12px; width: 100%; margin-top: 24px; }

    button.primary-btn {
      border: 0; border-radius: 14px; padding: 14px 24px; cursor: pointer;
      background: #2563eb; color: #ffffff; font-weight: 800; font-size: 1rem;
      box-shadow: 6px 6px 12px rgba(163, 177, 198, 0.45), -6px -6px 12px rgba(255, 255, 255, 0.75);
      width: 100%; max-width: 240px;
      display: flex; justify-content: center; align-items: center;
    }
    button.primary-btn:active { transform: translateY(2px); box-shadow: inset 4px 4px 8px rgba(0,0,0,0.2); }

    button.secondary-btn {
      border: 0; background: transparent; cursor: pointer;
      color: #6b7890; font-size: 0.9rem; font-weight: 600; text-decoration: underline;
      padding: 10px;
    }
    button.secondary-btn:hover { color: #2563eb; }

    .small { margin-top: 20px; font-size: 0.85rem; color: #6b7890; line-height: 1.4; }
    .hide { display: none !important; }
  </style>

  <script>
    const APP_URL = "https://script.google.com/macros/s/AKfycbzLyWl4cHIEmwPDhjMGADoWN1MHa2OLhkVtcJldWDlHzRgyz-Yb9CGNleaiwmrV1-ZvBg/exec";

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js", { scope: "./" }).catch(console.error);
    }
  </script>
</head>

<body>

<div id="installUI" class="wrap">
  <div class="card">
    <h1>ğŸ“± ìš°ì„±ê³  ì¹´ë“œ</h1>
    <p class="desc" id="topMsg">ì•± ì‚¬ìš©ì„ ìœ„í•´ ì„¤ì¹˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>

    <div>
      <span class="badge" id="envBadge">í™˜ê²½ í™•ì¸ ì¤‘â€¦</span>
      <div id="warnMsg" class="warn hide">
        âš ï¸ ë³´ì•ˆìƒ <b>ì™¸ë¶€ ë¸Œë¼ìš°ì €</b>ê°€ í•„ìš”í•©ë‹ˆë‹¤.<br>Chrome(ì•ˆë“œë¡œì´ë“œ) ë˜ëŠ” Safari(ì•„ì´í°)ë¡œ ì—´ì–´ì£¼ì„¸ìš”.
      </div>
    </div>

    <ol id="steps"></ol>

    <div class="btns">
      <button id="installBtn" class="primary-btn hide" type="button">ì•± ì„¤ì¹˜í•˜ê¸°</button>
      <button id="openWebBtn" class="secondary-btn" type="button">ì„¤ì¹˜ ì—†ì´ ë°”ë¡œ ì‹¤í–‰í•˜ê¸°</button>
    </div>

    <div class="small">
      ì„¤ì¹˜ê°€ ì™„ë£Œë˜ë©´ í™ˆ í™”ë©´ì— ì¶”ê°€ëœ<br><b>[ìš°ì„±ê³  ì¹´ë“œ]</b> ì•„ì´ì½˜ìœ¼ë¡œ ì ‘ì†í•´ì£¼ì„¸ìš”.
    </div>
  </div>
</div>

<script>
  const $ = id => document.getElementById(id);

  // âœ… (ì¶”ì²œ) ë’¤ë¡œê°€ê¸° í˜¼ë€ ë°©ì§€: replace ì‚¬ìš©
  function openAppTopLevel() {
    $("installUI").classList.add("hide");
    window.location.replace(APP_URL);
  }

  function setSteps(arr) {
    const ol = $("steps");
    if (!arr || arr.length === 0) {
      ol.innerHTML = "";
      ol.style.display = "none";
      return;
    }
    ol.style.display = "inline-block";
    ol.innerHTML = arr.map(v => `<li>${v}</li>`).join("");
  }

  document.addEventListener("DOMContentLoaded", () => {
    // 1) Standalone(PWA) ëª¨ë“œ ê°ì§€
    const isStandalone =
      window.matchMedia("(display-mode: standalone)").matches ||
      window.navigator.standalone === true;

    if (isStandalone) {
      $("installUI").classList.add("hide");
      window.location.replace(APP_URL);
      return;
    }

    // 2) í™˜ê²½ ê°ì§€ (PC / Android / iOS / InApp)
    const ua = navigator.userAgent.toLowerCase();
    const isiOS = /iphone|ipad|ipod/.test(ua);
    const isAndroid = /android/.test(ua);

    // âœ… ì›¨ì¼ ì œì™¸ + ë„¤ì´ë²„ ì¸ì•±ë§Œ ê°ì§€
    const isInApp =
      /kakaotalk|instagram|fbav|fban|\bline\b/i.test(ua) ||
      (/naver/i.test(ua) && /inapp|app/i.test(ua));

    $("envBadge").textContent =
      isInApp ? "ì¸ì•± ë¸Œë¼ìš°ì €" :
      isiOS ? "iOS (ì•„ì´í°)" :
      isAndroid ? "Android (ì•ˆë“œë¡œì´ë“œ)" :
      "PC (ë°ìŠ¤í¬í†±)";

    // ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
    $("openWebBtn").addEventListener("click", openAppTopLevel);

    // [CASE A] ì¸ì•± ë¸Œë¼ìš°ì €
    if (isInApp) {
      $("warnMsg").classList.remove("hide");
      $("topMsg").innerHTML = "ì´ê³³ì—ì„œëŠ” ì•± ì„¤ì¹˜ê°€ ì œí•œë©ë‹ˆë‹¤.";
      $("openWebBtn").classList.add("hide");

      setSteps([
        "í™”ë©´ì˜ <b>[ì  3ê°œ]</b> ë˜ëŠ” <b>[ê³µìœ ]</b> ë²„íŠ¼ í´ë¦­",
        "<b>[ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¡œ ì—´ê¸°</b>(ë˜ëŠ” <b>ê¸°ë³¸ ë¸Œë¼ìš°ì €ë¡œ ì—´ê¸°</b>) ì„ íƒ",
        "Chrome ë˜ëŠ” Safariì—ì„œ ë‹¤ì‹œ ì‹œë„"
      ]);
      return;
    }

    // [CASE B] iOS (ìˆ˜ë™ ì„¤ì¹˜ ì•ˆë‚´)
    if (isiOS) {
      $("topMsg").innerHTML = "ì•„ì´í°ì€ <b>í™ˆ í™”ë©´ì— ì¶”ê°€</b>í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.";
      setSteps([
        "í•˜ë‹¨ ë˜ëŠ” ìƒë‹¨ì˜ <b>ê³µìœ  ë²„íŠ¼(<i class='fa-solid fa-arrow-up-from-bracket'></i>)</b> í´ë¦­",
        "ë©”ë‰´ì—ì„œ <b>[í™ˆ í™”ë©´ì— ì¶”ê°€]</b> ì„ íƒ",
        "ìš°ì¸¡ ìƒë‹¨ <b>[ì¶”ê°€]</b> ë²„íŠ¼ í´ë¦­"
      ]);
      return;
    }

    // [CASE C] PC (ì„¤ì¹˜ ë¶ˆí•„ìš”)
    if (!isAndroid) {
      $("topMsg").innerHTML = "PCì—ì„œëŠ” ì„¤ì¹˜ ì—†ì´ ë°”ë¡œ ì‹¤í–‰í•´ë„ ë©ë‹ˆë‹¤.";
      setSteps([]);
      $("installBtn").classList.add("hide");
      return;
    }

    // [CASE D] Android (ì„¤ì¹˜ ë²„íŠ¼ ì œê³µ + ì´ë²¤íŠ¸ ë¯¸ë°œìƒ ëŒ€ë¹„)
    $("topMsg").innerHTML =
      "ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì•±ì„ ì„¤ì¹˜í•˜ì„¸ìš”.<br><span style='font-size:0.85rem;color:#6b7890;font-weight:normal'>(ë²„íŠ¼ì´ ì•ˆ ëœ¨ë©´ ë¸Œë¼ìš°ì € ë©”ë‰´ì—ì„œ 'í™ˆ í™”ë©´ì— ì¶”ê°€' ì„ íƒ)</span>";
    setSteps([]);

    let deferredPrompt = null;
    let bipFired = false;

    window.addEventListener("beforeinstallprompt", e => {
      e.preventDefault();
      deferredPrompt = e;
      bipFired = true;
      $("installBtn").classList.remove("hide");
    });

    // âœ… 3ì´ˆ ë‚´ ì´ë²¤íŠ¸ê°€ ì•ˆ ëœ¨ë©´ ìˆ˜ë™ ì•ˆë‚´ë¡œ ì „í™˜
    setTimeout(() => {
      if (!bipFired) {
        $("installBtn").classList.add("hide");
        setSteps([
          "ì˜¤ë¥¸ìª½ ìœ„ <b>(â‹®)</b> ë©”ë‰´ í´ë¦­",
          "<b>[í™ˆ í™”ë©´ì— ì¶”ê°€]</b> ë˜ëŠ” <b>[ì•± ì„¤ì¹˜]</b> ì„ íƒ"
        ]);
      }
    }, 3000);

    $("installBtn").addEventListener("click", async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      try {
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === "accepted") $("installBtn").classList.add("hide");
      } catch (err) {
        console.log("Install prompt error:", err);
      }
      deferredPrompt = null;
    });
  });
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
</body>
</html>
