<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>ìš°ì„±ê³  ì¹´ë“œ ì„¤ì¹˜</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#e0e5ec" />

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="ìš°ì„±ê³  ì¹´ë“œ" />
  <link rel="apple-touch-icon" href="./icon-192.png" />

  <style>
    html, body { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; overflow: hidden; }

    body{
      display:flex; justify-content:center; align-items:center;
      background: linear-gradient(-45deg, #e0e5ec, #d1d9e6, #c8d0e7, #b8c6dc);
      background-size: 400% 400%;
      animation: bg 15s ease infinite;
      color:#3d4a5c;
    }
    @keyframes bg { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

    .wrap { width: min(560px, 92vw); position: relative; z-index: 10; }
    .card {
      background:#e0e5ec; border-radius:26px; padding:30px 26px;
      box-shadow: 9px 9px 16px rgba(163,177,198,0.7), -9px -9px 16px rgba(255,255,255,0.9);
      text-align:center;
    }

    h1 { margin:0 0 10px; font-size:1.6rem; color:#3d4a5c; }
    .desc { color:#5a677b; margin-bottom:20px; line-height:1.5; font-size:1.05rem; word-break:keep-all; }
    .badge { display:inline-block; padding:6px 12px; border-radius:999px; background: rgba(0,0,0,0.06); font-size:0.9rem; color:#5a677b; margin-bottom:10px; }
    .warn { margin-top:10px; font-weight:800; color:#d63031; font-size:0.95rem; }
    .hide { display:none !important; }

    ol { margin: 15px 0 0 0; padding-left: 20px; text-align:left; line-height:1.8; color:#5a677b; display:inline-block; }
    li { margin: 8px 0; }

    .btns { display:flex; justify-content:center; width:100%; margin-top:24px; }
    button.primary-btn{
      border:0; border-radius:14px; padding:14px 24px; cursor:pointer;
      background:#2563eb; color:#fff; font-weight:800; font-size:1rem;
      box-shadow: 6px 6px 12px rgba(163, 177, 198, 0.45), -6px -6px 12px rgba(255, 255, 255, 0.75);
      width:100%; max-width:240px;
      display:flex; justify-content:center; align-items:center; text-align:center; line-height:1.2;
    }
    button.primary-btn:active { transform: translateY(2px); box-shadow: inset 4px 4px 8px rgba(0,0,0,0.2); }

    .small { margin-top:20px; font-size:0.85rem; color:#6b7890; line-height:1.4; }

    iframe { position: fixed; inset: 0; width: 100%; height: 100%; border: 0; display:none; background:#fff; z-index: 100; -webkit-overflow-scrolling: touch; }

    /* âœ… í‰ì†Œì—” ìˆ¨ê¹€. ì—…ë¡œë“œ(ì˜ìˆ˜ì¦) ë™ì‘ ë•Œë§Œ ë‚˜íƒ€ë‚˜ëŠ” 'ë¹„ìƒ ë²„íŠ¼' */
    #emergencyBtn{
      position: fixed; right: 16px; bottom: 18px; z-index: 9999;
      display:none; opacity:0; transition: opacity .25s ease;
      border: 1px solid rgba(37,99,235,0.25);
      background: rgba(224,229,236,0.88);
      backdrop-filter: blur(8px);
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 0.85rem;
      font-weight: 800;
      color: #2563eb;
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
      cursor: pointer;
    }
    #emergencyBtn.show{ display:block; opacity:1; }
  </style>

  <script>
    // âœ… GAS ì›¹ì•± ì£¼ì†Œ
    const APP_URL = "https://script.google.com/macros/s/AKfycbzLyWl4cHIEmwPDhjMGADoWN1MHa2OLhkVtcJldWDlHzRgyz-Yb9CGNleaiwmrV1-ZvBg/exec";

    // ì„œë¹„ìŠ¤ì›Œì»¤ ë“±ë¡ (PWA)
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js", { scope: "./" }).catch(console.error);
    }
  </script>
</head>

<body>
  <iframe id="appFrame" title="ìš°ì„±ê³  ì¹´ë“œ ì‹œìŠ¤í…œ" allow="camera; microphone; geolocation; autoplay; fullscreen"></iframe>

  <button id="emergencyBtn" type="button">ì‚¬ì§„ ì²¨ë¶€ê°€ ì•ˆë ë•Œ í´ë¦­!</button>

  <div id="installUI" class="wrap">
    <div class="card">
      <h1>ğŸ“± ìš°ì„±ê³  ì¹´ë“œ</h1>
      <p class="desc" id="topMsg">ì•±ì²˜ëŸ¼ ì‚¬ìš©í•˜ë ¤ë©´ ì„¤ì¹˜(í™ˆí™”ë©´ ì¶”ê°€)ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>

      <div>
        <span class="badge" id="envBadge">í™˜ê²½ í™•ì¸ ì¤‘â€¦</span>
        <div id="warnMsg" class="warn hide">
          âš ï¸ ì¹´ì¹´ì˜¤í†¡/ë„¤ì´ë²„ ë“± ì•± ì•ˆì—ì„œëŠ” ì„¤ì¹˜ê°€ ì˜ ì•ˆë©ë‹ˆë‹¤.<br>
          ê¼­ Chrome(ì•ˆë“œë¡œì´ë“œ) / Safari(ì•„ì´í°)ì—ì„œ ì—´ì–´ì£¼ì„¸ìš”.
        </div>
      </div>

      <ol id="steps"></ol>

      <div class="btns">
        <button id="installBtn" class="primary-btn hide" type="button">ì•± ì„¤ì¹˜í•˜ê¸°</button>
      </div>

      <div class="small">
        ì„¤ì¹˜ê°€ ì™„ë£Œë˜ë©´ í™ˆ í™”ë©´ì— ì¶”ê°€ëœ<br><b>[ìš°ì„±ê³  ì¹´ë“œ]</b> ì•„ì´ì½˜ìœ¼ë¡œ ì ‘ì†í•´ì£¼ì„¸ìš”.
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  function showAppInIframe(){
    $("installUI").classList.add("hide");
    const f = $("appFrame");
    f.src = APP_URL;
    f.style.display = "block";
  }

  function openSafeModeTopLevel(){
    // iframeì—ì„œ ì—…ë¡œë“œê°€ ë§‰íˆë©´ 'ì§ì ‘ ì—´ê¸°(ê°€ì¥ ì•ˆì •)'ë¡œ ì „í™˜
    if (confirm("ì˜ìˆ˜ì¦ ì—…ë¡œë“œê°€ ì˜ ì•ˆ ë˜ë‚˜ìš”?\ní™•ì¸ì„ ëˆ„ë¥´ë©´ 'ì§ì ‘ ì—°ê²° ëª¨ë“œ'ë¡œ ì „í™˜í•©ë‹ˆë‹¤.")) {
      window.location.replace(APP_URL);
    }
  }

  function setSteps(arr){
    const ol = $("steps");
    if (!arr || arr.length === 0) { ol.innerHTML = ""; ol.style.display = "none"; return; }
    ol.style.display = "inline-block";
    ol.innerHTML = arr.map(v => `<li>${v}</li>`).join("");
  }

  // âœ… ë¹„ìƒ ë²„íŠ¼: í‰ì†Œ ìˆ¨ê¹€ â†’ ì—…ë¡œë“œ ê´€ë ¨ ë™ì‘ì´ ê°ì§€ë  ë•Œë§Œ ë…¸ì¶œ
  function showEmergencyBtn(){
    const b = $("emergencyBtn");
    b.classList.add("show");
  }
  function hideEmergencyBtn(){
    const b = $("emergencyBtn");
    b.classList.remove("show");
    // display:none ì²˜ë¦¬ ìœ„í•´ ì•½ê°„ ê¸°ë‹¤ë ¸ë‹¤ê°€ ì œê±°
    setTimeout(()=>{ if(!b.classList.contains("show")) b.style.display="none"; }, 260);
  }
  $("emergencyBtn").addEventListener("click", openSafeModeTopLevel);

  // âœ… GAS(iframe ë‚´ë¶€)ì—ì„œ ë³´ë‚´ëŠ” postMessage ìˆ˜ì‹ 
  window.addEventListener("message", (e) => {
    // origin ì²´í¬: iframe ë‚´ë¶€ëŠ” script.google.comì—ì„œ ì˜´
    if (!e.origin || !e.origin.includes("script.google.com")) return;

    const data = e.data || {};
    if (data.source !== "WS_CARD") return;

    if (data.type === "UPLOAD_PICKER_OPEN" || data.type === "UPLOAD_START" || data.type === "UPLOAD_PICKER_TIMEOUT") {
      showEmergencyBtn();
      return;
    }
    if (data.type === "UPLOAD_END") {
      hideEmergencyBtn();
      return;
    }
  });

  document.addEventListener("DOMContentLoaded", () => {
    // 1) ì•±(Standalone) ëª¨ë“œ ê°ì§€
    const isStandalone =
      window.matchMedia("(display-mode: standalone)").matches ||
      window.navigator.standalone === true;

    // âœ… ì„¤ì¹˜ëœ ì•±ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì´ë©´: ë°”ë¡œ iframeì— GAS ë¡œë“œ (ë°°ë„ˆ ì•ˆ ëœ¸)
    if (isStandalone) {
      showAppInIframe();
      return;
    }

    // 2) í™˜ê²½ ê°ì§€
    const ua = navigator.userAgent.toLowerCase();
    const isiOS = /iphone|ipad|ipod/.test(ua);
    const isAndroid = /android/.test(ua);

    // ì¸ì•± ë¸Œë¼ìš°ì € ê°ì§€ (ì¹´í†¡/ë„¤ì´ë²„/ì¸ìŠ¤íƒ€/í˜ë¶/ë¼ì¸ ë“±)
    const isInApp =
      /kakaotalk|instagram|fbav|fban|\bline\b/i.test(ua) ||
      (/naver/i.test(ua) && /inapp|app/i.test(ua));

    $("envBadge").textContent =
      isInApp ? "ì¸ì•± ë¸Œë¼ìš°ì €" :
      isiOS ? "iOS (ì•„ì´í°)" :
      isAndroid ? "Android (ì•ˆë“œë¡œì´ë“œ)" :
      "PC (ë°ìŠ¤í¬í†±)";

    // 3) ì¸ì•±ì´ë©´ ê²½ê³  + ì„¤ì¹˜ ì•ˆë‚´ë§Œ
    if (isInApp) {
      $("warnMsg").classList.remove("hide");
      $("topMsg").innerHTML = "ì„¤ì¹˜ë¥¼ ìœ„í•´ <b>ì™¸ë¶€ ë¸Œë¼ìš°ì €</b>ë¡œ ì—´ì–´ì£¼ì„¸ìš”.";
      setSteps([
        "í™”ë©´ì˜ <b>[â‹¯]</b> ë˜ëŠ” <b>[ê³µìœ ]</b> ë²„íŠ¼ í´ë¦­",
        "<b>[ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¡œ ì—´ê¸°]</b> ì„ íƒ",
        "Chrome ë˜ëŠ” Safariì—ì„œ ë‹¤ì‹œ ì‹œë„"
      ]);
      return;
    }

    // 4) iOSëŠ” ìˆ˜ë™(í™ˆí™”ë©´ ì¶”ê°€) ì•ˆë‚´
    if (isiOS) {
      $("topMsg").innerHTML = "ì•„ì´í°ì€ <b>í™ˆ í™”ë©´ì— ì¶”ê°€</b>í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.";
      setSteps([
        "Safariì—ì„œ ì´ í˜ì´ì§€ë¥¼ ì—´ê¸°",
        "í•˜ë‹¨ì˜ <b>ê³µìœ  ë²„íŠ¼(â¬†ï¸)</b> í´ë¦­",
        "ë©”ë‰´ì—ì„œ <b>[í™ˆ í™”ë©´ì— ì¶”ê°€]</b> ì„ íƒ",
        "ìš°ì¸¡ ìƒë‹¨ <b>[ì¶”ê°€]</b> ë²„íŠ¼ í´ë¦­"
      ]);
      return;
    }

    // 5) AndroidëŠ” ì„¤ì¹˜ ë²„íŠ¼(ê°€ëŠ¥í•  ë•Œë§Œ) ë…¸ì¶œ
    $("topMsg").innerHTML = "ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì•±ì„ ì„¤ì¹˜í•˜ì„¸ìš”.";
    setSteps([]);

    let deferredPrompt = null;
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      $("installBtn").classList.remove("hide");
    });

    $("installBtn").addEventListener("click", async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      try { await deferredPrompt.userChoice; } catch(_){}
      deferredPrompt = null;
      $("installBtn").classList.add("hide");
    });
  });
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
</body>
</html>
